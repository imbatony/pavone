# PAVOne v0.2.0 开发计划

## 1. Jellyfin 集成 (优先级: 高) ✅ 已完成

### 功能需求
- [x] 连接 Jellyfin 服务器（支持用户名密码/API Key认证）
- [x] 支持在 Jellyfin 中搜索视频
- [x] 下载前检查视频是否已在 Jellyfin 中存在
- [x] 查看 Jellyfin 中指定视频的详细信息
- [x] 显示视频元数据（媒体流、演员、导演等）

### 技术方案
- 使用 `jellyfin-apiclient-python` 库处理 API 交互（官方库，成熟稳定）
- 创建 `jellyfin/` 模块封装 Jellyfin 业务逻辑
- 扩展 Search 插件支持 Jellyfin 搜索
- 在下载流程中添加去重检查
- 支持自动刷新 Jellyfin 库

### 依赖库
- `jellyfin-apiclient-python` - 官方 Jellyfin API 客户端

### 交付物
- `pavone/jellyfin/` 模块
- Jellyfin 配置文档
- 测试用例

---

## 2. 元数据获取器 (优先级: 高) 🚀 开发中

### 功能目标
- [ ] 从指定 identifier 提取视频元数据
- [ ] 支持多个元数据源网站（Missav、JAVDB、Javmost 等）
- [ ] 显示提取的完整元数据信息
- [ ] 支持将元数据应用到 Jellyfin 中的指定视频
- [ ] 支持在 Jellyfin 中搜索视频后选择应用

### 元数据源（至少支持 2-3 个）
- [ ] **Missav** - 提供详细的视频元数据和多格式链接
- [ ] **JAVDB** - 综合日本AV数据库，元数据完整度高
- [ ] **Javmost** - 提供详细的演员、导演、发行商信息
- [ ] **Jav321** - 备选数据源

### 功能设计

#### 2.1 元数据获取器框架
- 创建 `pavone/metadata/` 模块
- 定义 `MetadataPlugin` 基类，支持任意 identifier（URL、视频代码等）
  - `can_extract(identifier: str) -> bool` - 检查是否能处理该 identifier
  - `extract_metadata(identifier: str) -> Dict` - 从 identifier 提取元数据
- 实现各数据源的具体提取器
- 根据 URL 域名自动匹配合适的提取器

#### 2.2 增强的元数据字段
- 基础字段：标题、发行日期、发行商、系列
- 演员信息：演员列表、角色、个人资料链接
- 内容元数据：类型、标签、评分、简介
- 媒体信息：时长、质量建议、多版本提示
- 来源跟踪：数据来源、获取时间、更新历史

#### 2.3 CLI 命令
- `pavone metadata show <identifier>` - 从指定 identifier 提取并显示视频的元数据信息
- `pavone metadata enrich <identifier> <video_id>` - 从指定 identifier 提取元数据并增强 Jellyfin 中的指定视频
- `pavone metadata enrich <identifier> --search <keyword>` - 从指定 identifier 提取元数据，搜索匹配的 Jellyfin 视频后由用户选择
- `pavone metadata enrich <identifier> <video_id> --force` - 强制覆盖所有字段（默认仅补充缺失信息）

#### 2.4 集成到现有功能
- 搜索结果中显示数据源和元数据完整度
- Info 命令显示数据来源和更新时间
- 支持在下载前自动获取完整元数据

#### 2.5 使用流程
**方式 1：查看元数据**
```bash
# identifier 可以是 URL
pavone metadata show https://missav.ai/ja/sdmt-415

# 也可以是视频代码或其他格式
pavone metadata show SDMT-415

# 系统自动识别 identifier 并调用对应的提取器获取元数据
# 输出：标题、发行日期、发行商、演员、导演、类型、标签等
```

**方式 2：直接指定 Jellyfin 视频增强元数据**
```bash
pavone metadata enrich https://missav.ai/ja/sdmt-415 <video_id>
# 或
pavone metadata enrich SDMT-415 <video_id>

# 从 identifier 提取元数据并直接应用到指定的 Jellyfin 视频
```

**方式 3：搜索 Jellyfin 视频后增强元数据**
```bash
pavone metadata enrich https://missav.ai/ja/sdmt-415 --search sdmt-415
# 或
pavone metadata enrich SDMT-415 --search sdmt-415

# 步骤：
# 1. 识别 identifier 并调用对应的提取器获取元数据
# 2. 在 Jellyfin 中搜索匹配的视频
# 3. 显示搜索结果，让用户选择要增强的视频
# 4. 应用元数据到选中的视频
```

#### 2.6 Enrich 功能详细设计

##### 2.6.1 工作流程
1. **提取远程元数据** - 从数据源获取完整元数据
2. **获取本地元数据** - 从 Jellyfin 获取指定视频的当前元数据
3. **对比差异** - 展示两边元数据的区别（彩色高亮）
   - 远程独有字段（绿色）
   - 本地独有字段（黄色）
   - 两边都有但不同的字段（蓝色）
   - 相同字段（灰色）
4. **用户确认** - 让用户确认是否继续 enrich
5. **下载远程图片** - 将远程图片（URL）下载到本地
6. **上传到 Jellyfin** - 将下载的图片和元数据上传到 Jellyfin
7. **生成更新记录** - 记录本次 enrich 的变更内容

##### 2.6.2 字段合并策略（增量更新）
- **默认行为（无 --force）**：
  - 本地有值的字段：保留本地值（不覆盖）
  - 本地无值的字段：使用远程值（补充）
  - 列表类字段（演员、类型等）：合并去重
  - 结果：保证信息只增不减
  
- **强制覆盖（--force）**：
  - 所有字段均使用远程值覆盖本地值
  - 谨慎使用，可能丢失本地数据

##### 2.6.3 图片处理
- **识别图片类型**：
  - 封面（Primary Image）
  - 缩略图（Thumb Image）
  - 背景图（Backdrop Images）
  
- **图片下载和上传流程**：
  1. 识别远程元数据中的所有图片 URL
  2. 逐个下载图片到临时目录
  3. 检查下载成功状态
  4. 调用 Jellyfin API 上传图片
  5. 清理临时文件
  
- **图片覆盖策略**：
  - 如果本地已有图片且非 --force：跳过该类型图片
  - 如果本地无图片：上传远程图片
  - --force 时：覆盖所有图片

##### 2.6.4 特殊字段处理
- **演员/导演/类型等列表**：
  - 默认：合并 Jellyfin 现有值和远程值，去重排序
  - --force：使用远程值完全替换
  
- **评分/分级**：
  - 默认：如果本地无评分，使用远程评分
  - --force：覆盖评分
  
- **简介/描述**：
  - 默认：如果本地简介少于 10 字，使用远程简介
  - --force：覆盖简介
  
- **系列/标签**：
  - 默认：合并去重
  - --force：使用远程值

##### 2.6.5 UI/UX 设计
- **差异对比显示**：
  ```
  【元数据对比】
  
  字段名          │ Jellyfin (本地)              │ Missav (远程)
  ────────────────┼──────────────────────────────┼──────────────────────────────
  标题            │ SDMT-415                     │ SDMT-415
  代码            │ SDMT-415                     │ SDMT-415
  发行日期        │ 2011-04-21                   │ 2011-04-21
  时长            │ 111 分钟                     │ 111 分钟
  演员            │ 佐藤遥希                     │ 佐藤遥希 (远程有5人)
  导演            │ (无)                         │ Keita★No.1 [新增]
  类型            │ デジモ                       │ デジモ, 女子校生, 巨乳 (新增2个)
  评分            │ (无)                         │ 7.4/10 [新增]
  描述            │ (无)                         │ さとう遥希（♀）は... [新增]
  ```
  
- **确认提示**：
  ```
  发现以下变更：
  + 5 个新字段会被添加
  ~ 2 个字段会被更新（合并）
  
  是否继续 enrich？ (y/n)
  ```

##### 2.6.6 错误处理
- 网络错误：图片下载失败时提示用户
- 上传失败：Jellyfin API 错误时回滚
- 权限错误：无权限修改时提示并跳过
- 数据验证：确保数据完整性后再上传

##### 2.6.7 日志记录
- 每次 enrich 记录：
  - 操作时间
  - 源和目标视频信息
  - 变更的字段列表
  - 是否使用 --force
  - 操作结果（成功/失败）
  - 添加/更新/合并的字段计数

### 开发流程
- 实现 `MetadataPlugin` 基类，定义 `can_extract` 和 `extract_metadata` 接口
- 为各数据源实现具体的提取器（继承 MetadataPlugin）
- 实现 identifier 识别逻辑，自动匹配合适的提取器（支持 URL、视频代码等多种格式）
- 实现元数据显示和格式化逻辑
- 实现 Jellyfin API 元数据更新接口
- 支持在 Jellyfin 中搜索并让用户选择视频
- 实现 enrich 功能：
  - 元数据对比和展示
  - 用户确认流程
  - 图片下载和上传
  - 增量合并策略
  - 错误处理和回滚
- 编写单元测试和集成测试
- 完善错误处理和日志记录

### 交付物
- 元数据获取器框架和实现
- 新的 CLI 命令
- Enrich 功能的完整实现
- 测试用例（覆盖率 > 80%）
- 文档说明和最佳实践指南

---

## 3. 下载缓存优化 (优先级: 中)

### 优化目标
- [ ] 实现智能缓存机制（避免重复下载相同链接）
- [ ] 支持缓存过期策略（TTL 配置）
- [ ] 缓存数据持久化（数据库或文件）
- [ ] 提供缓存统计和管理命令

### 技术方案
- 在 `Manager` 中添加缓存层
- 使用 SQLite 存储缓存元数据
- 支持缓存预热和清理
- 添加缓存命中率监控

### 交付物
- 缓存管理模块
- 新的 CLI 命令：`pavone cache clear/stats/warm`
- 文档说明

---

## 4. 元数据本地数据库缓存 (优先级: 高)

### 功能需求
- [ ] 构建元数据本地 SQLite 数据库
- [ ] 支持按视频代码、标题、网站等多维度查询
- [ ] 自动去重（同一视频的多个源只保存一份）
- [ ] 支持元数据版本管理和更新
- [ ] 提供元数据导入导出功能

### 技术方案
- 创建 `pavone/database/` 模块处理数据库操作
- 定义元数据 Schema（支持扩展字段）
- 实现 ORM 层简化数据操作
- 在提取器中集成数据库存储
- 在搜索时优先查询本地数据库

### 数据库设计
- **videos** 表 - 核心元数据
- **sources** 表 - 多源跟踪
- **metadata_history** 表 - 版本历史
- **search_index** 表 - 优化搜索性能

### 新增 CLI 命令
- `pavone db init` - 初始化数据库
- `pavone db query` - 查询元数据
- `pavone db export` - 导出数据
- `pavone db import` - 导入数据
- `pavone db stats` - 统计信息

### 交付物
- 数据库模块和 ORM
- 新的 CLI 命令实现
- 数据库迁移脚本
- 文档和使用示例

---

## 5. 其他改进 (优先级: 低)

### 代码质量
- [ ] 提高单元测试覆盖率（目标 > 85%）
- [ ] 添加更多集成测试
- [ ] 性能优化分析

### 文档完善
- [ ] 更新 API 文档
- [ ] 添加开发者指南示例
- [ ] 补充常见问题 (FAQ)

### 依赖更新
- [ ] 评估和更新主要依赖
- [ ] 检查安全漏洞

---

## 开发时间线

| 阶段 | 任务 | 状态 | 预计时间 |
|------|------|------|--------|
| Phase 1 | Jellyfin 集成 | ✅ 完成 | 1-2 周 |
| Phase 2 | 元数据获取器框架 | 🚀 进行中 | 1-2 周 |
| Phase 2.1 | Missav 数据源实现 | ✅ 完成 | - |
| Phase 2.2 | Enrich 功能开发 | ✅ 完成 | 1-2 周 |
| Phase 3 | 其他数据源实现（JAVDB、Javmost）| ⏳ 待开始 | 1-2 周 |
| Phase 4 | 元数据数据库缓存 | ⏳ 待开始 | 1 周 |
| Phase 5 | 下载缓存优化 | ⏳ 待开始 | 1 周 |
| Phase 6 | 测试和优化 | ⏳ 待开始 | 1 周 |
| Phase 7 | 发布准备 | ⏳ 待开始 | 3-5 天 |

---

## 发布检查清单

- [x] Jellyfin 集成功能已完成
- [x] 元数据获取器框架已实现
- [x] Missav 数据源已实现
- [x] Enrich 功能已实现并测试通过
  - [x] 元数据对比展示功能
  - [x] 用户确认流程
  - [x] 图片下载和上传功能框架
  - [x] 增量合并策略
  - [x] 强制覆盖选项
  - [x] 错误处理
- [ ] 所有功能已实现并测试通过
- [ ] 代码审查完成
- [ ] 文档已更新
- [ ] 变更日志 (CHANGELOG) 已更新
- [ ] 版本号确认为 0.2.0
- [ ] 标签 (tag) 已创建
- [ ] 发布说明已准备