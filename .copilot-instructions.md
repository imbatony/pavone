# GitHub Copilot 指令文件

## 项目概述

**PAVOne** 是一个插件化的视频管理工具，集下载、元数据管理、文件整理和搜索功能于一体。

**语言**: Python 3.9+  
**类型**: 命令行应用程序 (CLI)  
**框架**: Click (命令行框架)  
**架构**: 插件化架构

---

## 语言和文档要求

### ⚠️ 强制性规范

1. **语言使用规范**:
   - **代码和参数**: 可以使用英文 (推荐遵循 Python 标准约定)
   - **文档字符串和注释**: **必须使用中文**
   
   ```python
   def download_video(url: str, output_path: str) -> bool:
       """下载视频到指定路径。
       
       参数:
           url: 视频的 URL 地址
           output_path: 保存文件的本地路径
           
       返回:
           是否下载成功
       """
       # 验证输入参数
       if not url:
           raise ValueError("URL 不能为空")
   ```

2. **文档添加原则**: **务必谨慎添加文档**
   - ❌ 不要为每个函数都添加冗余文档
   - ❌ 不要创建不必要的 .md 文件
   - ✅ 只在代码意图不明显时才添加中文注释和文档字符串
   - ✅ 优先通过清晰的英文变量名和函数名表达意图
   - ✅ 仅在项目级别维护核心文档 (README、docs 文件夹)

---

## 代码风格和规范

### Python 代码规范

1. **代码格式**: 使用 Black 进行格式化
   - 行长: 88 字符
   - 缩进: 4 个空格
   
2. **类型注解**: 强制使用类型注解
   ```python
   def process_video(path: str, metadata: Dict[str, Any]) -> bool:
       pass
   ```

3. **命名约定**:
   - 类名: `PascalCase` (如 `VideoDownloader`)
   - 函数/方法: `snake_case` (如 `download_video`)
   - 常量: `UPPER_SNAKE_CASE` (如 `DEFAULT_TIMEOUT`)
   - 私有成员: `_leading_underscore`

4. **导入顺序**:
   ```python
   # 标准库
   import os
   from pathlib import Path
   
   # 第三方库
   import requests
   from pydantic import BaseModel
   
   # 本地导入
   from pavone.core.base import BaseDownloader
   ```

5. **文档字符串**: 使用中文 docstring
   - 遵循 Google 风格，文档字符串和注释使用中文
   - 代码本身可使用英文，但说明文字必须是中文
   ```python
   def download_file(url: str, path: str) -> bool:
       """下载文件到指定路径。
       
       参数:
           url: 文件的 URL 地址
           path: 保存文件的本地路径
           
       返回:
           是否下载成功
           
       异常:
           requests.RequestException: 网络请求失败
           IOError: 文件写入失败
       """
   ```

---

## 项目结构

```
pavone/
├── cli/              # 命令行接口
│   └── commands/     # 各个命令实现
├── core/             # 核心功能
│   ├── downloader/   # 下载器实现
│   └── metadata/     # 元数据处理
├── config/           # 配置管理
├── manager/          # 业务逻辑协调
├── models/           # 数据模型和常量
├── plugins/          # 插件系统
│   ├── extractors/   # 元数据提取器
│   ├── search/       # 搜索插件
│   └── metadata/     # 元数据处理插件
└── utils/            # 工具函数
```

---

## 关键设计模式

### 1. 插件架构

所有插件继承自基类并实现标准接口:

```python
from pavone.plugins.base import BasePlugin

class MyPlugin(BasePlugin):
    name = "my_plugin"
    version = "1.0.0"
    
    def execute(self) -> Any:
        pass
```

### 2. 配置管理

使用 Pydantic 模型定义配置:

```python
from pydantic import BaseModel

class DownloaderConfig(BaseModel):
    timeout: int = 30
    max_retries: int = 3
    proxy: Optional[str] = None
```

### 3. 下载器基类

所有下载器继承 `BaseDownloader`:

```python
class HTTPDownloader(BaseDownloader):
    def download(self, url: str, output_path: str) -> None:
        pass
```

---

## 命令行界面

### 命令结构

使用 Click 框架开发 CLI:

```python
import click

@click.group()
def cli():
    """PAVOne 命令行工具"""
    pass

@cli.command()
@click.option('--url', required=True, help='视频 URL')
@click.option('--output', default='.', help='输出目录')
def download(url: str, output: str):
    """下载视频"""
    pass
```

### 现有命令

- `pavone init` - 初始化配置
- `pavone download` - 下载视频
- `pavone organize` - 整理文件
- `pavone search` - 搜索视频
- `pavone config` - 管理配置

---

## 测试规范

### ⚠️ 测试文件位置强制要求

**所有测试文件必须放在 `tests/` 文件夹下，不允许例外**

```
tests/
├── test_downloader.py
├── test_av01_extractor.py
├── data/              # 测试数据
└── conftest.py        # pytest 配置
```

- ✅ 测试代码可使用英文命名 (遵循 pytest 约定)
- ✅ 测试函数中的中文注释和 docstring 描述测试目的
- ❌ 不要在源代码目录中添加测试文件
- ❌ 不要在其他目录放置测试代码

### 测试编写

使用 `pytest` 框架，代码使用英文，注释和文档使用中文:

```python
import pytest
from pavone.core.downloader import HTTPDownloader

def test_http_downloader_initialization():
    """HTTP 下载器初始化测试"""
    downloader = HTTPDownloader()
    assert downloader is not None

@pytest.mark.parametrize("url,expected", [
    ("http://example.com/video.mp4", True),
    ("invalid-url", False),
])
def test_url_validation(url: str, expected: bool):
    """验证 URL 格式的测试"""
    pass
```

**运行测试**:
```bash
uv run pytest tests/ -v
```

---

## 开发工作流

### 1. 新功能开发

- 在相应模块中创建实现
- 添加类型注解和文档字符串
- 编写相应的单元测试
- 确保代码通过 Black 格式化
- 提交 PR 前运行完整测试套件

### 2. 添加新的下载器

```python
from pavone.core.downloader.base import BaseDownloader

class NewDownloader(BaseDownloader):
    """新的下载器实现"""
    
    def download(self, url: str, output_path: str) -> None:
        """实现下载逻辑"""
        pass
```

### 3. 添加新的提取器

```python
from pavone.plugins.extractors.base import BaseExtractor

class NewExtractor(BaseExtractor):
    name = "new_extractor"
    
    def extract(self, source: str) -> Dict[str, Any]:
        """提取元数据"""
        pass
```

### 4. 添加新的搜索插件

```python
from pavone.plugins.search.base import BaseSearchPlugin

class NewSearchPlugin(BaseSearchPlugin):
    name = "new_search"
    
    def search(self, keyword: str) -> List[Dict]:
        """搜索实现"""
        pass
```

---

## 依赖管理

### ⚠️ 强制使用 uv 包管理器

**务必使用 `uv` 原生命令管理依赖，不允许使用 pip**

❌ **禁止使用 `uv pip install`** - 这是错误的做法
✅ **只能使用 `uv add` 来添加依赖**

常用命令:
```bash
# 同步依赖
uv sync

# 添加依赖 (正确方式)
uv add package_name

# ❌ 不要这样做 (错误)
# uv pip install package_name

# 添加开发依赖
uv add --dev pytest

# 更新依赖
uv lock --upgrade

# 运行脚本
uv run python script.py
uv run pytest
```

### 项目依赖

- **requests**: HTTP 请求
- **beautifulsoup4**: HTML 解析
- **click**: 命令行框架
- **tqdm**: 进度条
- **pydantic**: 数据验证
- **pillow**: 图像处理
- **lxml**: XML/HTML 解析

---

## 错误处理

### 异常层次

定义项目特定的异常:

```python
class PAVOneException(Exception):
    """基础异常"""
    pass

class DownloadError(PAVOneException):
    """下载错误"""
    pass

class ExtractionError(PAVOneException):
    """提取错误"""
    pass
```

### 使用异常

```python
try:
    download_video(url)
except DownloadError as e:
    logger.error(f"下载失败: {e}")
    raise
```

---

## 日志

使用标准 Python logging:

```python
import logging

logger = logging.getLogger(__name__)

logger.debug("调试信息")
logger.info("普通信息")
logger.warning("警告信息")
logger.error("错误信息")
```

---

## 配置文件

配置文件位置: `~/.pavone/config.ini` 或项目根目录 `pavone.config`

支持的配置:

```ini
[download]
timeout = 30
max_retries = 3
proxy = http://proxy.example.com:8080

[output]
video_dir = ./videos
metadata_dir = ./metadata
```

---

## 性能考虑

1. **并发下载**: 使用 ThreadPoolExecutor 实现并发
2. **缓存**: 缓存元数据提取结果
3. **流处理**: 大文件使用流式处理
4. **进度监控**: 使用 tqdm 进行进度反馈

---

## 常见任务

### 添加新命令

```python
# pavone/cli/commands/new_command.py
import click

@click.command()
@click.option('--param', help='参数说明')
def new_command(param: str):
    """命令描述"""
    pass
```

然后在 `pavone/cli/__init__.py` 中注册:

```python
from pavone.cli.commands.new_command import new_command

cli.add_command(new_command)
```

### 注册新插件

在 `pavone/plugins/manager.py` 中:

```python
self.register_plugin(MyPlugin())
```

---

## 资源

- **主文档**: 查看 `docs/` 目录
- **配置文档**: `docs/config.md`
- **使用文档**: `docs/usage.md`
- **开发文档**: `docs/development.md`

---

## 最佳实践

1. ✅ 始终添加类型注解
2. ✅ 使用清晰的英文变量和函数名表达意图
3. ✅ 添加必要的中文注释和文档字符串解释复杂逻辑
4. ✅ 所有测试必须放在 `tests/` 文件夹下
5. ✅ 为新功能编写测试
6. ✅ 使用 Click 的 Group 和 Command 组织命令
7. ✅ 使用 Pydantic 模型验证配置
8. ✅ 记录异常但让调用者处理
9. ✅ 使用枚举处理常量集合
10. ✅ 对外部 API 调用进行错误处理和重试
11. ✅ 使用 `uv` 管理所有依赖和脚本运行

---

## 禁止做的事

1. ❌ 不要忽略类型错误
2. ❌ 不要硬编码配置值
3. ❌ 不要跳过错误处理
4. ❌ 不要修改全局状态
5. ❌ 不要使用 `except Exception` (过于宽泛)
6. ❌ 不要忘记关闭资源 (使用 `with` 语句)
7. ❌ 不要在主代码中混入测试代码
8. ❌ **不要使用 pip 管理依赖，只能使用 uv**
9. ❌ **不要使用 `uv pip install`，必须使用 `uv add` 添加依赖**
10. ❌ **不要在非 tests/ 目录放置测试文件**
11. ❌ **不要忽略中文注释和文档字符串，这些必须清晰**
12. ❌ **不要随意添加文档文件，仅在确实需要时添加**

---

**更新日期**: 2025-12-05  
**维护者**: PAVOne Team
